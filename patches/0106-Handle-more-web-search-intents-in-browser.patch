From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: quh4gko8 <88831734+quh4gko8@users.noreply.github.com>
Date: Wed, 28 Sep 2022 05:37:00 +0200
Subject: [PATCH] Handle more web search intents in browser

---
 .../src/org/chromium/base/PackageManagerUtils.java     | 10 ++++++++++
 chrome/android/java/AndroidManifest.xml                |  5 +++++
 .../browser/document/ChromeLauncherActivity.java       |  2 +-
 3 files changed, 16 insertions(+), 1 deletion(-)

diff --git a/base/android/java/src/org/chromium/base/PackageManagerUtils.java b/base/android/java/src/org/chromium/base/PackageManagerUtils.java
index 56b1dcd70350e..1fa3a887eccb3 100644
--- a/base/android/java/src/org/chromium/base/PackageManagerUtils.java
+++ b/base/android/java/src/org/chromium/base/PackageManagerUtils.java
@@ -96,6 +96,16 @@ public class PackageManagerUtils {
         return pm.hasSystemFeature(feature);
     }
 
+    public static boolean canOnlyOthersResolveActivity(Intent intent, int flags) {
+        for (ResolveInfo ri: queryIntentActivities(intent, flags)) {
+            if (ContextUtils.getApplicationContext()
+                    .getPackageName().equals(ri.activityInfo.packageName)) {
+                return false;
+            }
+        }
+        return true;
+    }
+
     /**
      * @return Intent to query a list of installed home launchers.
      */
diff --git a/chrome/android/java/AndroidManifest.xml b/chrome/android/java/AndroidManifest.xml
index c75a6da6e85d6..977173cff1196 100644
--- a/chrome/android/java/AndroidManifest.xml
+++ b/chrome/android/java/AndroidManifest.xml
@@ -1017,6 +1017,11 @@ by a child template that "extends" this file.
                 <!-- Permits Chrome to act as a default handler for WEB_SEARCH intents. -->
                 <category android:name="android.intent.category.DEFAULT" />
             </intent-filter>
+            <!-- Allows handling GLOBAL_SEARCH intents as well -->
+            <intent-filter> <!-- DOWNSTREAM -->
+                <action android:name="android.search.action.GLOBAL_SEARCH" />
+                <category android:name="android.intent.category.DEFAULT" />
+            </intent-filter> <!-- DOWNSTREAM -->
       </activity>
 
         <!-- GcmListenerService for messages from GCM. -->
diff --git a/chrome/android/java/src/org/chromium/chrome/browser/document/ChromeLauncherActivity.java b/chrome/android/java/src/org/chromium/chrome/browser/document/ChromeLauncherActivity.java
index cb7c36fb5b94f..9d12638baf5d2 100644
--- a/chrome/android/java/src/org/chromium/chrome/browser/document/ChromeLauncherActivity.java
+++ b/chrome/android/java/src/org/chromium/chrome/browser/document/ChromeLauncherActivity.java
@@ -167,7 +167,7 @@ public class ChromeLauncherActivity extends Activity {
         Intent searchIntent = new Intent(Intent.ACTION_WEB_SEARCH);
         searchIntent.putExtra(SearchManager.QUERY, query);
 
-        if (PackageManagerUtils.canResolveActivity(
+        if (PackageManagerUtils.canOnlyOthersResolveActivity(
                 searchIntent, PackageManager.GET_RESOLVED_FILTER)) {
             startActivity(searchIntent);
         } else {
