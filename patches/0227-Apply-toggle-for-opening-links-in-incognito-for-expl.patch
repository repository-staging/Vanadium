From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: vanadium-staging <107577710+vanadium-staging@users.noreply.github.com>
Date: Sat, 29 Nov 2025 16:43:14 +0000
Subject: [PATCH] Apply toggle for opening links in incognito for explicit
 intents

---
 .../chrome/browser/ChromeTabbedActivity.java  |  4 +++
 .../browser/LaunchIntentDispatcher.java       |  3 ++
 .../browser/LaunchIntentDispatcherHooks.java  | 31 +++++++++++++++++++
 3 files changed, 38 insertions(+)

diff --git a/chrome/android/java/src/org/chromium/chrome/browser/ChromeTabbedActivity.java b/chrome/android/java/src/org/chromium/chrome/browser/ChromeTabbedActivity.java
index c7355d94cdb9f..eac9581d27ac9 100644
--- a/chrome/android/java/src/org/chromium/chrome/browser/ChromeTabbedActivity.java
+++ b/chrome/android/java/src/org/chromium/chrome/browser/ChromeTabbedActivity.java
@@ -1663,6 +1663,8 @@ public class ChromeTabbedActivity extends ChromeActivity implements PreAttachInt
                 return;
             }
 
+            intent = LaunchIntentDispatcherHooks.maybeModifyMainOrExplicitIntents(this, intent);
+
             // The intent to use in maybeDispatchExplicitMainViewIntent(). We're explicitly
             // adding NEW_TASK flag to make sure backing from CCT brings up the caller activity,
             // and not Chrome
@@ -2159,6 +2161,8 @@ public class ChromeTabbedActivity extends ChromeActivity implements PreAttachInt
             Log.i(TAG, "#initializeState");
             Intent intent = getIntent();
 
+            intent = LaunchIntentDispatcherHooks.maybeModifyMainOrExplicitIntents(this, intent);
+
             boolean hadCipherData = false;
             PersistableBundle persistentState = getPersistentInstanceState();
             if (shouldPersistAcrossReboots() && persistentState != null) {
diff --git a/chrome/android/java/src/org/chromium/chrome/browser/LaunchIntentDispatcher.java b/chrome/android/java/src/org/chromium/chrome/browser/LaunchIntentDispatcher.java
index 6d58ebd6da16d..8383fca2cd84a 100644
--- a/chrome/android/java/src/org/chromium/chrome/browser/LaunchIntentDispatcher.java
+++ b/chrome/android/java/src/org/chromium/chrome/browser/LaunchIntentDispatcher.java
@@ -348,6 +348,9 @@ public class LaunchIntentDispatcher {
                     "Android.Intent.HasNonSpoofablePackageName", hasNonSpoofablePackageName());
             boolean identityShared = maybePutCallingAppPackage(newIntent);
             RecordHistogram.recordBooleanHistogram("Android.Intent.IdentityShared", identityShared);
+        } else {
+            newIntent = LaunchIntentDispatcherHooks.maybeModifyMainOrExplicitIntents(
+                    mActivity, newIntent);
         }
 
         if (mActivity instanceof ChromeLauncherActivity) {
diff --git a/chrome/android/java/src/org/chromium/chrome/browser/LaunchIntentDispatcherHooks.java b/chrome/android/java/src/org/chromium/chrome/browser/LaunchIntentDispatcherHooks.java
index 15ce590a23a0a..e3f8c19657965 100644
--- a/chrome/android/java/src/org/chromium/chrome/browser/LaunchIntentDispatcherHooks.java
+++ b/chrome/android/java/src/org/chromium/chrome/browser/LaunchIntentDispatcherHooks.java
@@ -4,6 +4,8 @@ import android.app.Activity;
 import android.content.Context;
 import android.content.Intent;
 
+import org.chromium.base.IntentUtils;
+
 public final class LaunchIntentDispatcherHooks {
 
     private static Intent maybeCreateIncognitoTabIntentFor(Context context, Intent intent) {
@@ -41,4 +43,33 @@ public final class LaunchIntentDispatcherHooks {
 
         return newIntent;
     }
+
+    static Intent maybeModifyMainOrExplicitIntents(Activity activity, Intent intent) {
+        if (intent == null) {
+            return intent;
+        }
+
+        String urlFromIntent = IntentHandler.getUrlFromIntent(intent);
+        if (urlFromIntent == null) {
+            return intent;
+        }
+
+        if (IntentUtils.safeGetBooleanExtra(intent,
+                IntentHandler.EXTRA_OPEN_NEW_INCOGNITO_TAB, false)) {
+            return intent;
+        }
+
+        if (IntentUtils.isTrustedIntentFromSelf(intent)) {
+            return intent;
+        }
+
+        if (intent.getComponent() == null
+                && !Intent.ACTION_MAIN.equals(intent.getAction())) {
+            return intent;
+        }
+
+        Intent newIntent = maybeCreateIncognitoTabIntentFor(activity, intent);
+
+        return newIntent;
+    }
 }
