From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: quh4gko8 <88831734+quh4gko8@users.noreply.github.com>
Date: Fri, 23 Jan 2026 15:20:18 +0000
Subject: [PATCH] net layer for fetching OS connectivity check settings

---
 net/conn_checks/android/BUILD.gn              | 114 ++++++++++++++++++
 net/conn_checks/android/conn_checks_util.cc   |  18 +++
 net/conn_checks/android/conn_checks_util.h    |  26 ++++
 net/conn_checks/android/features.cc           |  36 ++++++
 net/conn_checks/android/features.h            |  16 +++
 .../conn_checks/ConnChecksFeatureList.java    |  16 +++
 .../net/conn_checks/ConnChecksFeatureMap.java |  40 ++++++
 .../net/conn_checks/ConnChecksUtil.java       |  73 +++++++++++
 8 files changed, 339 insertions(+)
 create mode 100644 net/conn_checks/android/BUILD.gn
 create mode 100644 net/conn_checks/android/conn_checks_util.cc
 create mode 100644 net/conn_checks/android/conn_checks_util.h
 create mode 100644 net/conn_checks/android/features.cc
 create mode 100644 net/conn_checks/android/features.h
 create mode 100644 net/conn_checks/android/java/src/org/chromium/net/conn_checks/ConnChecksFeatureList.java
 create mode 100644 net/conn_checks/android/java/src/org/chromium/net/conn_checks/ConnChecksFeatureMap.java
 create mode 100644 net/conn_checks/android/java/src/org/chromium/net/conn_checks/ConnChecksUtil.java

diff --git a/net/conn_checks/android/BUILD.gn b/net/conn_checks/android/BUILD.gn
new file mode 100644
index 0000000000000..5ad9a89fa5040
--- /dev/null
+++ b/net/conn_checks/android/BUILD.gn
@@ -0,0 +1,114 @@
+import("//build/config/android/config.gni")
+import("//build/config/android/rules.gni")
+import("//third_party/jni_zero/jni_zero.gni")
+
+assert(is_android)
+
+java_cpp_features("java_features_srcjar") {
+  # External code should depend on ":features_java" instead.
+  visibility = [ ":*" ]
+  sources = [ "features.cc" ]
+  class_name = "org.chromium.net.conn_checks.ConnChecksFeatures"
+}
+
+android_library("features_java") {
+  srcjar_deps = [ ":java_features_srcjar" ]
+}
+
+android_library("feature_map_java") {
+  sources = [
+    "java/src/org/chromium/net/conn_checks/ConnChecksFeatureList.java",
+    "java/src/org/chromium/net/conn_checks/ConnChecksFeatureMap.java",
+  ]
+
+  deps = [
+    ":features_java",
+    "//base:base_java",
+    "//build/android:build_java",
+    "//third_party/jni_zero:jni_zero_java",
+  ]
+
+  srcjar_deps = [
+    ":feature_map_jni_headers",
+  ]
+}
+
+generate_jni("feature_map_jni_headers") {
+  visibility = [ ":*" ]
+  sources = [
+    "java/src/org/chromium/net/conn_checks/ConnChecksFeatureMap.java",
+  ]
+}
+
+source_set("feature_map") {
+  sources = [
+    "features.cc",
+    "features.h",
+  ]
+
+  deps = [
+    ":feature_map_jni_headers",
+    "//base",
+    "//net:net_export_header",
+  ]
+
+  public_deps = [
+  ]
+}
+
+java_cpp_enum("conn_checks_util_java_enums_srcjar") {
+  # External code should depend on ":conn_checks_util_enums_java" instead.
+  visibility = [ ":*" ]
+  sources = [
+    "conn_checks_util.h",
+  ]
+}
+
+android_library("conn_checks_util_enums_java") {
+  deps = [
+    "//third_party/androidx:androidx_annotation_annotation_java",
+  ]
+  srcjar_deps = [ ":conn_checks_util_java_enums_srcjar" ]
+}
+
+android_library("conn_checks_util_java") {
+  sources = [
+    "java/src/org/chromium/net/conn_checks/ConnChecksUtil.java",
+  ]
+
+  deps = [
+    ":conn_checks_util_enums_java",
+    ":feature_map_java",
+    ":features_java",
+    "//base:base_java",
+    "//build/android:build_java",
+    "//third_party/jni_zero:jni_zero_java",
+  ]
+
+  srcjar_deps = [
+    ":conn_checks_util_jni_headers",
+  ]
+}
+
+generate_jni("conn_checks_util_jni_headers") {
+  visibility = [ ":*" ]
+  sources = [
+    "java/src/org/chromium/net/conn_checks/ConnChecksUtil.java",
+  ]
+}
+
+source_set("conn_checks_util") {
+  sources = [
+    "conn_checks_util.cc",
+    "conn_checks_util.h",
+  ]
+
+  deps = [
+    ":conn_checks_util_jni_headers",
+    ":feature_map",
+    "//base",
+  ]
+
+  public_deps = [
+  ]
+}
diff --git a/net/conn_checks/android/conn_checks_util.cc b/net/conn_checks/android/conn_checks_util.cc
new file mode 100644
index 0000000000000..7e56a7dd17f95
--- /dev/null
+++ b/net/conn_checks/android/conn_checks_util.cc
@@ -0,0 +1,18 @@
+#include "net/conn_checks/android/conn_checks_util.h"
+
+#include "base/android/jni_android.h"
+
+#include "net/conn_checks/android/conn_checks_util_jni_headers/ConnChecksUtil_jni.h"
+
+namespace net::android {
+
+ConnChecksOsSetting GetConnChecksOsSetting() {
+  JNIEnv* env = base::android::AttachCurrentThread();
+  int setting = Java_ConnChecksUtil_getConnChecksSetting(env);
+  return (setting < GRAPHENEOS || setting > DISABLED)
+            ? GRAPHENEOS : static_cast<ConnChecksOsSetting>(setting);
+}
+
+} // namespace net::android
+
+DEFINE_JNI(ConnChecksUtil)
diff --git a/net/conn_checks/android/conn_checks_util.h b/net/conn_checks/android/conn_checks_util.h
new file mode 100644
index 0000000000000..a309bf4de556a
--- /dev/null
+++ b/net/conn_checks/android/conn_checks_util.h
@@ -0,0 +1,26 @@
+#ifndef NET_CONN_CHECKS_ANDROID_CONN_CHECKS_UTIL_H_
+#define NET_CONN_CHECKS_ANDROID_CONN_CHECKS_UTIL_H_
+
+#include <jni.h>
+#include <string_view>
+
+namespace net::android {
+
+inline constexpr std::string_view kGrapheneOsDohProbeHostname =
+    "connectivitycheck.grapheneos.network";
+
+// Keep in sync with the OS counterpart settings value and name.
+// GENERATED_JAVA_ENUM_PACKAGE: org.chromium.net.conn_checks
+enum ConnChecksOsSetting {
+  GRAPHENEOS = 0,
+  STANDARD = 1,
+  DISABLED = 2,
+  DEFAULT = GRAPHENEOS,
+};
+
+ConnChecksOsSetting GetConnChecksOsSetting();
+
+}  // namespace net::android
+
+
+#endif // NET_CONN_CHECKS_ANDROID_CONN_CHECKS_UTIL_H_
diff --git a/net/conn_checks/android/features.cc b/net/conn_checks/android/features.cc
new file mode 100644
index 0000000000000..10e77bc9cf5fe
--- /dev/null
+++ b/net/conn_checks/android/features.cc
@@ -0,0 +1,36 @@
+#include "net/conn_checks/android/features.h"
+
+#include "base/android/feature_map.h"
+#include "base/android/jni_android.h"
+#include "base/feature_list.h"
+#include "base/no_destructor.h"
+
+#include "net/conn_checks/android/feature_map_jni_headers/ConnChecksFeatureMap_jni.h"
+
+namespace net::android::features {
+
+namespace {
+
+const base::Feature* const kFeaturesExposedToJava[] = {
+    &kRespectConnChecksOsSetting
+};
+
+// static
+base::android::FeatureMap* GetFeatureMap() {
+  static base::NoDestructor<base::android::FeatureMap> kFeatureMap(
+      kFeaturesExposedToJava);
+  return kFeatureMap.get();
+}
+
+} // namespace
+
+BASE_FEATURE(kRespectConnChecksOsSetting, base::FEATURE_ENABLED_BY_DEFAULT);
+
+static jlong JNI_ConnChecksFeatureMap_GetNativeMap(JNIEnv* env) {
+  return reinterpret_cast<jlong>(GetFeatureMap());
+}
+
+} // namespace net::android::features
+
+DEFINE_JNI(ConnChecksFeatureMap)
+
diff --git a/net/conn_checks/android/features.h b/net/conn_checks/android/features.h
new file mode 100644
index 0000000000000..c49df4e448c43
--- /dev/null
+++ b/net/conn_checks/android/features.h
@@ -0,0 +1,16 @@
+#ifndef NET_CONN_CHECKS_ANDROID_FEATURE_H_
+#define NET_CONN_CHECKS_ANDROID_FEATURE_H_
+
+#include <jni.h>
+
+#include "base/feature_list.h"
+#include "net/base/net_export.h"
+
+namespace net::android::features {
+
+NET_EXPORT BASE_DECLARE_FEATURE(kRespectConnChecksOsSetting);
+
+}  // namespace net::android::features
+
+
+#endif // NET_CONN_CHECKS_ANDROID_FEATURE_H_
diff --git a/net/conn_checks/android/java/src/org/chromium/net/conn_checks/ConnChecksFeatureList.java b/net/conn_checks/android/java/src/org/chromium/net/conn_checks/ConnChecksFeatureList.java
new file mode 100644
index 0000000000000..c7226508c0c61
--- /dev/null
+++ b/net/conn_checks/android/java/src/org/chromium/net/conn_checks/ConnChecksFeatureList.java
@@ -0,0 +1,16 @@
+package org.chromium.net.conn_checks;
+
+import static org.chromium.net.conn_checks.ConnChecksFeatures.*;
+
+public final class ConnChecksFeatureList {
+
+    private static final String TAG = "ConnChecksFeatureList";
+
+    private ConnChecksFeatureList() {
+    }
+
+    public static boolean shouldRespectOsSetting() {
+        return ConnChecksFeatureMap.isEnabled(RESPECT_CONN_CHECKS_OS_SETTING);
+    }
+}
+
diff --git a/net/conn_checks/android/java/src/org/chromium/net/conn_checks/ConnChecksFeatureMap.java b/net/conn_checks/android/java/src/org/chromium/net/conn_checks/ConnChecksFeatureMap.java
new file mode 100644
index 0000000000000..3f8931e264159
--- /dev/null
+++ b/net/conn_checks/android/java/src/org/chromium/net/conn_checks/ConnChecksFeatureMap.java
@@ -0,0 +1,40 @@
+package org.chromium.net.conn_checks;
+
+import org.jni_zero.JNINamespace;
+import org.jni_zero.NativeMethods;
+
+import org.chromium.base.FeatureMap;
+import org.chromium.base.Log;
+import org.chromium.build.annotations.NonNull;
+import org.chromium.build.annotations.NullMarked;
+
+/** Class to access DNS server configuration. */
+@JNINamespace("net::android::features")
+@NullMarked
+public final class ConnChecksFeatureMap extends FeatureMap {
+
+    private static final String TAG = "ConnChecksFeatureMap";
+    private static final @NonNull ConnChecksFeatureMap sInstance = new ConnChecksFeatureMap();
+
+    private ConnChecksFeatureMap() {
+    }
+
+    private static ConnChecksFeatureMap getInstance() {
+        return sInstance;
+    }
+
+    static boolean isEnabled(String featureName) {
+        return getInstance().isEnabledInNative(featureName);
+    }
+
+    @Override
+    protected long getNativeMap() {
+        return ConnChecksFeatureMapJni.get().getNativeMap();
+    }
+
+    @NativeMethods
+    public interface Natives {
+        long getNativeMap();
+    }
+}
+
diff --git a/net/conn_checks/android/java/src/org/chromium/net/conn_checks/ConnChecksUtil.java b/net/conn_checks/android/java/src/org/chromium/net/conn_checks/ConnChecksUtil.java
new file mode 100644
index 0000000000000..a88a868275cc2
--- /dev/null
+++ b/net/conn_checks/android/java/src/org/chromium/net/conn_checks/ConnChecksUtil.java
@@ -0,0 +1,73 @@
+package org.chromium.net.conn_checks;
+
+import org.jni_zero.CalledByNative;
+import org.jni_zero.JNINamespace;
+
+import org.chromium.base.Log;
+import org.chromium.build.annotations.NullMarked;
+import org.chromium.build.annotations.Nullable;
+
+import java.lang.reflect.Method;
+import java.lang.reflect.InvocationTargetException;
+
+/** Class to access DNS server configuration. */
+@JNINamespace("net::android")
+@NullMarked
+public final class ConnChecksUtil {
+
+    private static final String TAG = "ConnChecksUtil";
+
+    private ConnChecksUtil() {
+    }
+
+    @CalledByNative
+    public static @ConnChecksOsSetting int getConnChecksSetting() {
+        if (!ConnChecksFeatureList.shouldRespectOsSetting()) {
+            Log.i(TAG, "respecting connn checks OS settings feature: disabled");
+            return ConnChecksOsSetting.GRAPHENEOS;
+        }
+
+        int connChecksSettingVal = getInner();
+
+        return switch (connChecksSettingVal) {
+            case ConnChecksOsSetting.GRAPHENEOS,
+                 ConnChecksOsSetting.STANDARD,
+                 ConnChecksOsSetting.DISABLED -> {
+                yield connChecksSettingVal;
+            }
+            default -> {
+                yield ConnChecksOsSetting.DEFAULT;
+            }
+        };
+    }
+
+    private static volatile boolean sConnChecksSettingGetMethodInited;
+    private static @Nullable Method sConnChecksSettingGetMethod;
+
+    private static int getInner() {
+        if (!sConnChecksSettingGetMethodInited) {
+            try {
+                Class<?> connChecksSettingClass =
+                        Class.forName("android.ext.settings.ConnChecksSetting");
+                sConnChecksSettingGetMethod =
+                        connChecksSettingClass.getDeclaredMethod("get");
+            } catch (ClassNotFoundException | NoSuchMethodException e) {
+                Log.e(TAG, "", e);
+            }
+
+            sConnChecksSettingGetMethodInited = true;
+        }
+
+        Method method = sConnChecksSettingGetMethod;
+        if (method == null) {
+            return ConnChecksOsSetting.DEFAULT;
+        }
+
+        try {
+            return (int) method.invoke(null);
+        } catch (InvocationTargetException | IllegalAccessException e) {
+            Log.e(TAG, "", e);
+            return ConnChecksOsSetting.DEFAULT;
+        }
+    }
+}
