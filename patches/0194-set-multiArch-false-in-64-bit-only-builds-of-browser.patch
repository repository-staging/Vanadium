From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: quh4gko8 <88831734+quh4gko8@users.noreply.github.com>
Date: Sat, 12 Jul 2025 16:30:34 +0000
Subject: [PATCH] set multiArch=false in 64-bit only builds of browser and
 webview

Since the placeholder libraries are not included in 64-bit only builds,
and it is not required for browser and webview apk build targets,
set multiArch=false to allow its installation on OS with 32-bit support.
---
 android_webview/nonembedded/java/AndroidManifest.xml     | 4 ++++
 android_webview/system_webview_apk_tmpl.gni              | 2 ++
 chrome/android/chrome_public_apk_tmpl.gni                | 4 ++++
 chrome/android/java/AndroidManifest_trichrome_chrome.xml | 4 ++++
 4 files changed, 14 insertions(+)

diff --git a/android_webview/nonembedded/java/AndroidManifest.xml b/android_webview/nonembedded/java/AndroidManifest.xml
index 5e58430a33918..f4ac495bac69b 100644
--- a/android_webview/nonembedded/java/AndroidManifest.xml
+++ b/android_webview/nonembedded/java/AndroidManifest.xml
@@ -45,7 +45,11 @@ by a child template that "extends" this file.
     <application android:label="{{ application_label|default('Vanadium System WebView') }}"
                  android:icon="@{{manifest_package|default('com.android.webview')}}:drawable/icon_webview"
                  android:name="{{ application_name|default('org.chromium.android_webview.nonembedded.WebViewApkApplication') }}"
+                 {% if has_secondary_abi is defined and has_secondary_abi == 'false' %}
+                 android:multiArch="false"
+                 {% else %}
                  android:multiArch="true"
+                 {% endif %}
                  android:memtagMode="async"
                  >
         {# This part is shared between stand-alone WebView and Monochrome #}
diff --git a/android_webview/system_webview_apk_tmpl.gni b/android_webview/system_webview_apk_tmpl.gni
index 84e2ab0a74256..fcef5d482110d 100644
--- a/android_webview/system_webview_apk_tmpl.gni
+++ b/android_webview/system_webview_apk_tmpl.gni
@@ -99,6 +99,8 @@ template("system_webview_apk_or_module_tmpl") {
       } else {
         variables += [ "library=libmonochrome.so" ]
       }
+      _has_secondary_abi = !android_64bit_target_cpu || _include_32_bit_webview
+      variables += [ "has_secondary_abi=$_has_secondary_abi" ]
     }
     includes = []
     if (defined(invoker.jinja_input)) {
diff --git a/chrome/android/chrome_public_apk_tmpl.gni b/chrome/android/chrome_public_apk_tmpl.gni
index 8d75f71b234f2..203a4f58c244c 100644
--- a/chrome/android/chrome_public_apk_tmpl.gni
+++ b/chrome/android/chrome_public_apk_tmpl.gni
@@ -200,6 +200,10 @@ template("chrome_common_apk_or_module_tmpl") {
     output = _android_manifest
     variables = default_chrome_public_jinja_variables +
                 [ "manifest_package=$_manifest_package" ]
+    if (_is_trichrome) {
+      _has_secondary_abi = !android_64bit_target_cpu || _include_32_bit_webview
+      variables += [ "has_secondary_abi=$_has_secondary_abi" ]
+    }
     if (_is_trichrome) {
       input = "//chrome/android/java/AndroidManifest_trichrome_chrome.xml"
       includes = [ "//chrome/android/java/AndroidManifest.xml" ]
diff --git a/chrome/android/java/AndroidManifest_trichrome_chrome.xml b/chrome/android/java/AndroidManifest_trichrome_chrome.xml
index 0f3d25bc30f92..d1313d753adc8 100644
--- a/chrome/android/java/AndroidManifest_trichrome_chrome.xml
+++ b/chrome/android/java/AndroidManifest_trichrome_chrome.xml
@@ -8,7 +8,11 @@
 
 {% block extra_application_attributes %}
 {{ super() }}
+{% if has_secondary_abi is defined and has_secondary_abi == 'false' %}
+android:multiArch="false"
+{% else %}
 android:multiArch="true"
+{% endif %}
 {% endblock %}
 
 {% block extra_keyset_definitions %}
