From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: vanadium-staging <107577710+vanadium-staging@users.noreply.github.com>
Date: Tue, 23 Dec 2025 14:34:28 +0000
Subject: [PATCH] tmp: 1/n temporary fixes for more build configurations for
 drumbrake

---
 ...rake-Linux-Windows-cross-compilation.patch | 228 ++++++++++++++++++
 1 file changed, 228 insertions(+)
 create mode 100644 vanadium/subprojects_patches/v8/0003-wasm-Fix-DrumBrake-Linux-Windows-cross-compilation.patch

diff --git a/vanadium/subprojects_patches/v8/0003-wasm-Fix-DrumBrake-Linux-Windows-cross-compilation.patch b/vanadium/subprojects_patches/v8/0003-wasm-Fix-DrumBrake-Linux-Windows-cross-compilation.patch
new file mode 100644
index 0000000000000..5dd6821afc755
--- /dev/null
+++ b/vanadium/subprojects_patches/v8/0003-wasm-Fix-DrumBrake-Linux-Windows-cross-compilation.patch
@@ -0,0 +1,228 @@
+From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
+From: Paolo Severini <paolosev@microsoft.com>
+Date: Sun, 30 Nov 2025 17:35:28 +0100
+Subject: [PATCH] [wasm] Fix DrumBrake  Linux->Windows cross-compilation
+
+Fixes the Wasm interpreter build when cross-compiling from Linux to
+Windows.
+Also disable a few Wasm mjsunit tests not supported in jitless mode.
+
+Bug: 435582611
+Change-Id: Iec808f770f1b108cb1702fa92b1fef0234534b26
+Reviewed-on: https://chromium-review.googlesource.com/c/v8/v8/+/7198890
+Reviewed-by: Matthias Liedtke <mliedtke@chromium.org>
+Commit-Queue: Paolo Severini <paolosev@microsoft.com>
+Reviewed-by: Daniel Lehmann <dlehmann@chromium.org>
+Cr-Commit-Position: refs/heads/main@{#104102}
+---
+ .../interpreter/wasm-interpreter-runtime.cc   |  5 +++--
+ .../interpreter/wasm-interpreter-runtime.h    |  5 +++--
+ .../x64/interpreter-builtins-x64.cc           | 20 +++++++++----------
+ test/message/message.status                   |  2 ++
+ test/mjsunit/mjsunit.status                   | 17 +++++++++++++++-
+ 5 files changed, 34 insertions(+), 15 deletions(-)
+
+diff --git a/src/wasm/interpreter/wasm-interpreter-runtime.cc b/src/wasm/interpreter/wasm-interpreter-runtime.cc
+index 401bf9c181a..95982a17ebb 100644
+--- a/src/wasm/interpreter/wasm-interpreter-runtime.cc
++++ b/src/wasm/interpreter/wasm-interpreter-runtime.cc
+@@ -2132,7 +2132,7 @@ int WasmInterpreterRuntime::instruction_table_offset() {
+   return OFFSET_OF(WasmInterpreterRuntime, instruction_table_);
+ }
+ 
+-#ifndef V8_DRUMBRAKE_BOUNDS_CHECKS
++#if defined(V8_ENABLE_DRUMBRAKE_TRACING) && !defined(V8_DRUMBRAKE_BOUNDS_CHECKS)
+ // static
+ int WasmInterpreterRuntime::trace_pop_func_offset() {
+   return OFFSET_OF(WasmInterpreterRuntime, trace_pop_func_);
+@@ -2152,7 +2152,8 @@ int WasmInterpreterRuntime::trace_push_func_offset() {
+ int WasmInterpreterRuntime::trace_replace_func_offset() {
+   return OFFSET_OF(WasmInterpreterRuntime, trace_replace_func_);
+ }
+-#endif  // V8_DRUMBRAKE_BOUNDS_CHECKS
++#endif  // defined(V8_ENABLE_DRUMBRAKE_TRACING) &&
++        // !defined(V8_DRUMBRAKE_BOUNDS_CHECKS)
+ 
+ struct StackHandlerMarker {
+   Address next;
+diff --git a/src/wasm/interpreter/wasm-interpreter-runtime.h b/src/wasm/interpreter/wasm-interpreter-runtime.h
+index f9bfcd6a90d..b7f06124731 100644
+--- a/src/wasm/interpreter/wasm-interpreter-runtime.h
++++ b/src/wasm/interpreter/wasm-interpreter-runtime.h
+@@ -207,12 +207,13 @@ class WasmInterpreterRuntime {
+   static int memory_start_offset();
+   static int instruction_table_offset();
+ 
+-#ifndef V8_DRUMBRAKE_BOUNDS_CHECKS
++#if defined(V8_ENABLE_DRUMBRAKE_TRACING) && !defined(V8_DRUMBRAKE_BOUNDS_CHECKS)
+   static int trace_pop_func_offset();
+   static int trace_pop2_func_offset();
+   static int trace_push_func_offset();
+   static int trace_replace_func_offset();
+-#endif  // V8_DRUMBRAKE_BOUNDS_CHECKS
++#endif  // defined(V8_ENABLE_DRUMBRAKE_TRACING) &&
++        // !defined(V8_DRUMBRAKE_BOUNDS_CHECKS)
+ 
+   size_t TotalBytecodeSize() const { return codemap_->TotalBytecodeSize(); }
+ 
+diff --git a/src/wasm/interpreter/x64/interpreter-builtins-x64.cc b/src/wasm/interpreter/x64/interpreter-builtins-x64.cc
+index 6b92a820aba..68c02b86087 100644
+--- a/src/wasm/interpreter/x64/interpreter-builtins-x64.cc
++++ b/src/wasm/interpreter/x64/interpreter-builtins-x64.cc
+@@ -903,12 +903,12 @@ void Builtins::Generate_WasmInterpreterCWasmEntry(MacroAssembler* masm) {
+   // rbp-0x08  Marker(StackFrame::C_WASM_ENTRY)
+   // rbp       Old RBP
+ 
+-#ifndef V8_OS_POSIX
++#ifdef V8_TARGET_OS_WIN
+   // Offsets for arguments passed in WasmToJSCallSig. See declaration of
+   // {WasmToJSCallSig} in src/wasm/interpreter/wasm-interpreter-runtime.h.
+   constexpr int kCEntryFpParameterOffset = 0x30;
+   constexpr int kCallableOffset = 0x38;
+-#endif  // !V8_OS_POSIX
++#endif  // V8_TARGET_OS_WIN
+ 
+   // Set up the stackframe.
+   __ EnterFrame(StackFrame::C_WASM_ENTRY);
+@@ -950,17 +950,17 @@ void Builtins::Generate_WasmInterpreterCWasmEntry(MacroAssembler* masm) {
+   isolate_root = no_reg;
+ 
+   Register callable = r8;
+-#ifdef V8_OS_POSIX
+-  __ movq(MemOperand(rbp, WasmInterpreterCWasmEntryConstants::kCEntryFPOffset),
+-          r8);            // saved_c_entry_fp
+-  __ movq(callable, r9);  // callable
+-#else                     // Windows
++#ifdef V8_TARGET_OS_WIN
+   // Store c_entry_fp into slot
+   __ movq(rbx, MemOperand(rbp, kCEntryFpParameterOffset));
+   __ movq(MemOperand(rbp, WasmInterpreterCWasmEntryConstants::kCEntryFPOffset),
+           rbx);
+   __ movq(callable, MemOperand(rbp, kCallableOffset));
+-#endif                    // V8_OS_POSIX
++#else   // !V8_TARGET_OS_WIN
++  __ movq(MemOperand(rbp, WasmInterpreterCWasmEntryConstants::kCEntryFPOffset),
++          r8);            // saved_c_entry_fp
++  __ movq(callable, r9);  // callable
++#endif  // V8_TARGET_OS_WIN
+ 
+   // Jump to a faked try block that does the invoke, with a faked catch
+   // block that sets the pending exception.
+@@ -1084,7 +1084,7 @@ void Builtins::Generate_GenericWasmToJSInterpreterWrapper(
+                      WasmToJSInterpreterFrameConstants::kGCScanSlotLimitOffset),
+           rsp);
+ 
+-#if V8_OS_POSIX
++#ifndef V8_TARGET_OS_WIN
+   // Windows has a different calling convention.
+   signature = r9;
+   __ movq(signature, kCArgRegs[3]);
+@@ -1092,7 +1092,7 @@ void Builtins::Generate_GenericWasmToJSInterpreterWrapper(
+   __ movq(target_js_function, kCArgRegs[0]);
+   packed_args = rdx;
+   __ movq(packed_args, kCArgRegs[1]);
+-#endif                    // V8_OS_POSIX
++#endif                    // !V8_TARGET_OS_WIN
+   __ movq(callable, r8);  // Callable passed in r8.
+ 
+   Register shared_function_info = r15;
+diff --git a/test/message/message.status b/test/message/message.status
+index b8c5f05e688..2c2fd7c91f8 100644
+--- a/test/message/message.status
++++ b/test/message/message.status
+@@ -87,7 +87,9 @@
+   # Tests that require compilation
+   'fail/wasm-async-compile-fail': [SKIP],
+   'js-wasm-wrapper-inlining-turbolev*': [SKIP],
++  'wasm-compilation-hints-inlining-no-liftoff': [SKIP],
+   'wasm-speculative-inlining': [SKIP],
++  'wasm-trace-globals': [SKIP],
+   'wasm-trace-turbofan': [SKIP],
+ 
+   # --trace-wasm-memory
+diff --git a/test/mjsunit/mjsunit.status b/test/mjsunit/mjsunit.status
+index 039640f5f23..d4e1c7ac7ab 100644
+--- a/test/mjsunit/mjsunit.status
++++ b/test/mjsunit/mjsunit.status
+@@ -680,7 +680,8 @@
+   'wasm/growable-stacks': [SKIP],
+ 
+   # --experimental-wasm-wasmfx
+-  'wasm/stack-switching': [SKIP],
++  'regress/wasm/regress-455832038': [SKIP],
++  'wasm/stack-switching*': [SKIP],
+ 
+   # --experimental-wasm-growable-stacks
+   'regress/wasm/regress-421055121': [SKIP],
+@@ -739,6 +740,7 @@
+   'regress/wasm/regress-834619': [SKIP],
+   'regress/wasm/regress-956771*': [SKIP],
+   'regress/wasm/regress-1430858': [SKIP],
++  'regress/wasm/regress-441844767': [SKIP],
+   'wasm/code-flushing*': [SKIP],
+   'wasm/lazy-compilation': [SKIP],
+   'wasm/lazy-feedback-vector-allocation': [SKIP],
+@@ -748,6 +750,7 @@
+   # --wasm-lazy-validation
+   'regress/wasm/regress-334687959': [SKIP],
+   'regress/wasm/regress-366350766': [SKIP],
++  'regress/wasm/regress-441221187': [SKIP],
+ 
+   # Wasm imported strings (just text-decoder or text-encoder)
+   'wasm/imported-strings-utf8': [SKIP],
+@@ -758,6 +761,7 @@
+   'regress/wasm/regress-327643791': [SKIP],
+ 
+   # --experimental-wasm-shared
++  'regress/wasm/regress-454276076': [SKIP],
+   'wasm/shared-everything/*': [SKIP],
+   'wasm/subtyping-invalid': [SKIP],
+ 
+@@ -775,6 +779,7 @@
+   'regress/wasm/regress-392928805': [SKIP],
+   'regress/wasm/regress-406043349': [SKIP],
+   'regress/wasm/regress-407298298': [SKIP],
++  'regress/wasm/regress-407797300': [SKIP],
+   'regress/wasm/regress-408254017': [SKIP],
+   'regress/wasm/regress-crbug-408253898': [SKIP],
+ 
+@@ -786,6 +791,7 @@
+   'wasm/redundant-shuffle-lanes': [SKIP],
+ 
+   # --experimental-wasm-rab-integration
++  'regress/wasm/regress-451144692': [SKIP],
+   'wasm/grow-huge-memory-resizable-buffer*': [SKIP],
+   'wasm/grow-memory-detaching-resizable-buffer': [SKIP],
+   'wasm/grow-memory-in-branch-resizable-buffer': [SKIP],
+@@ -801,8 +807,15 @@
+ 
+   # --experimental-wasm-custom-descriptors
+   'regress/wasm/regress-433984397': [SKIP],
++  'regress/wasm/regress-435301441': [SKIP],
++  'regress/wasm/regress-435315689': [SKIP],
++  'regress/wasm/regress-436362279': [SKIP],
++  'regress/wasm/regress-436937141': [SKIP],
++  'regress/wasm/regress-443377612': [SKIP],
+   'regress/wasm/regress-447613211': [SKIP],
+   'regress/wasm/regress-448404198': [SKIP],
++  'regress/wasm/regress-452541294': [SKIP],
++  'regress/wasm/regress-457106696': [SKIP],
+   'wasm/custom-descriptors*': [SKIP],
+   'wasm/exact-types': [SKIP],
+ 
+@@ -812,6 +825,7 @@
+ 
+   # --enable-testing-opcode-in-wasm
+   'regress/wasm/regress-377971725': [SKIP],
++  'regress/wasm/regress-426164352': [SKIP],
+ 
+   # Module serialization tests expect compilation
+   'regress/wasm/regress-11024': [SKIP],
+@@ -864,6 +878,7 @@
+   'regress/wasm/regress-368241691': [SKIP],
+   'regress/wasm/regress-373702823': [SKIP],
+   'regress/wasm/regress-383356864': [SKIP],
++  'regress/wasm/regress-456319253': [SKIP],
+   'regress/wasm/regress-crbug-1507751': [SKIP],
+   'wasm/bit-shift-right': [SKIP],
+   'wasm/bounds-check-turbofan': [SKIP],
