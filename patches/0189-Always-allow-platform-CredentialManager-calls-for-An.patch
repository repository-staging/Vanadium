From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: quh4gko8 <88831734+quh4gko8@users.noreply.github.com>
Date: Wed, 26 Feb 2025 09:46:02 +0000
Subject: [PATCH] Always allow platform CredentialManager calls for Android 15+

---
 .../webauthn/AuthenticatorImpl.java           | 22 +++++++++++++++++++
 .../cred_man/CredManSupportProvider.java      |  6 +++++
 2 files changed, 28 insertions(+)

diff --git a/components/webauthn/android/java/src/org/chromium/components/webauthn/AuthenticatorImpl.java b/components/webauthn/android/java/src/org/chromium/components/webauthn/AuthenticatorImpl.java
index 12a3bda72b94d..667a6b3ba2452 100644
--- a/components/webauthn/android/java/src/org/chromium/components/webauthn/AuthenticatorImpl.java
+++ b/components/webauthn/android/java/src/org/chromium/components/webauthn/AuthenticatorImpl.java
@@ -166,6 +166,11 @@ public final class AuthenticatorImpl implements Authenticator, AuthenticationCon
         mIsPaymentRequest = options.isPaymentCredentialCreation;
         mRequestCallback = requestCallback;
         mRequestCallback.setCompletionCallback(this::cleanupRequest);
+        // START CHANGE downstream: Always route to Android 15's CredMan
+        if (android.os.Build.VERSION.SDK_INT >= android.os.Build.VERSION_CODES.VANILLA_ICE_CREAM) {
+            // Skip GMSCore checks.
+        } else
+        // END CHANGE downstream: Always route to Android 15's CredMan
         if (!GmsCoreUtils.isWebauthnSupported()
                 || (!isChrome(mWebContents) && !GmsCoreUtils.isResultReceiverSupported())) {
             mRequestCallback.onComplete(
@@ -250,6 +255,11 @@ public final class AuthenticatorImpl implements Authenticator, AuthenticationCon
                         && DeviceFeatureMap.isEnabled(
                                 DeviceFeatureList
                                         .WEBAUTHN_AUTHENTICATOR_PASSWORDS_ONLY_IMMEDIATE_REQUESTS);
+        // START CHANGE downstream: Always route to Android 15's CredMan
+        if (android.os.Build.VERSION.SDK_INT >= android.os.Build.VERSION_CODES.VANILLA_ICE_CREAM) {
+            // Skip GMSCore checks.
+        } else
+        // END CHANGE downstream: Always route to Android 15's CredMan
         if (!GmsCoreUtils.isWebauthnSupported()
                 || (!isChrome(mWebContents) && !GmsCoreUtils.isResultReceiverSupported())
                 || (options.publicKey == null && !isPasswordOnlyFlux)) {
@@ -291,10 +301,22 @@ public final class AuthenticatorImpl implements Authenticator, AuthenticationCon
     }
 
     private boolean couldSupportConditionalMediation() {
+        // START CHANGE downstream: Always route to Android 15's CredMan
+        if (android.os.Build.VERSION.SDK_INT >= android.os.Build.VERSION_CODES.VANILLA_ICE_CREAM) {
+            // Skip GMSCore checks.
+            return true;
+        }
+        // END CHANGE downstream: Always route to Android 15's CredMan
         return GmsCoreUtils.isWebauthnSupported() && isChrome(mWebContents);
     }
 
     private boolean couldSupportUvpaa() {
+        // START CHANGE downstream: Always route to Android 15's CredMan
+        if (android.os.Build.VERSION.SDK_INT >= android.os.Build.VERSION_CODES.VANILLA_ICE_CREAM) {
+            // Skip GMSCore checks.
+            return true;
+        }
+        // END CHANGE downstream: Always route to Android 15's CredMan
         return GmsCoreUtils.isWebauthnSupported()
                 && (isChrome(mWebContents) || GmsCoreUtils.isResultReceiverSupported());
     }
diff --git a/components/webauthn/android/java/src/org/chromium/components/webauthn/cred_man/CredManSupportProvider.java b/components/webauthn/android/java/src/org/chromium/components/webauthn/cred_man/CredManSupportProvider.java
index 26fa7d1c6b43e..0b5d85168b707 100644
--- a/components/webauthn/android/java/src/org/chromium/components/webauthn/cred_man/CredManSupportProvider.java
+++ b/components/webauthn/android/java/src/org/chromium/components/webauthn/cred_man/CredManSupportProvider.java
@@ -82,6 +82,12 @@ public class CredManSupportProvider {
             log(TAG, "Disabled because of Android version.");
             return sCredManSupport;
         }
+        // START CHANGE downstream: Always route to Android 15's CredMan
+        if (android.os.Build.VERSION.SDK_INT >= android.os.Build.VERSION_CODES.VANILLA_ICE_CREAM) {
+            log(TAG, "Skipped GMS checks because of Android version is 15 or newer");
+            // Skip GMSCore checks.
+        } else
+        // END CHANGE downstream: Always route to Android 15's CredMan
         if (notSkippedBecauseInTests() && hasOldGmsVersion()) {
             sCredManSupport = CredManSupport.DISABLED;
             log(TAG, "Disabled because of old GMS version.");
