From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: vanadium-staging <107577710+vanadium-staging@users.noreply.github.com>
Date: Tue, 13 Jan 2026 03:17:28 +0000
Subject: [PATCH] tmp: 2/n build fixes with wasm in interpreter mode support
 enabled

---
 ...asm-interpreter-Fix-BranchOnCastData.patch | 77 +++++++++++++++++++
 1 file changed, 77 insertions(+)
 create mode 100644 vanadium/subprojects_patches/v8/0004-Wasm-interpreter-Fix-BranchOnCastData.patch

diff --git a/vanadium/subprojects_patches/v8/0004-Wasm-interpreter-Fix-BranchOnCastData.patch b/vanadium/subprojects_patches/v8/0004-Wasm-interpreter-Fix-BranchOnCastData.patch
new file mode 100644
index 0000000000000..1bec5c4bbf422
--- /dev/null
+++ b/vanadium/subprojects_patches/v8/0004-Wasm-interpreter-Fix-BranchOnCastData.patch
@@ -0,0 +1,77 @@
+From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
+From: Paolo Severini <paolosev@microsoft.com>
+Date: Sun, 11 Jan 2026 12:50:45 +0100
+Subject: [PATCH] [Wasm interpreter] Fix BranchOnCastData
+
+Fix BranchOnCastData after recent change.
+
+Change-Id: I512be6eca06f5e1e85295881088211ccae8fae5c
+Reviewed-on: https://chromium-review.googlesource.com/c/v8/v8/+/7440116
+Reviewed-by: Victor Gomes <victorgomes@chromium.org>
+Reviewed-by: Daniel Lehmann <dlehmann@chromium.org>
+Commit-Queue: Paolo Severini <paolosev@microsoft.com>
+Cr-Commit-Position: refs/heads/main@{#104634}
+---
+ src/wasm/interpreter/wasm-interpreter.cc | 2 +-
+ src/wasm/interpreter/wasm-interpreter.h  | 7 +++++--
+ test/mjsunit/mjsunit.status              | 2 ++
+ 3 files changed, 8 insertions(+), 3 deletions(-)
+
+diff --git a/src/wasm/interpreter/wasm-interpreter.cc b/src/wasm/interpreter/wasm-interpreter.cc
+index 2972396b732..428edd60495 100644
+--- a/src/wasm/interpreter/wasm-interpreter.cc
++++ b/src/wasm/interpreter/wasm-interpreter.cc
+@@ -9825,7 +9825,7 @@ RegMode WasmBytecodeGenerator::DoEncodeInstruction(const WasmInstruction& instr,
+       const BranchOnCastData& br_on_cast_data = instr.optional.br_on_cast_data;
+       int32_t target_branch_index =
+           GetTargetBranch(br_on_cast_data.label_depth());
+-      bool null_succeeds = br_on_cast_data.res_is_null;
++      bool null_succeeds = br_on_cast_data.res_is_null();
+       HeapType br_on_cast_data_target_type =
+           HeapType::FromBits(br_on_cast_data.target_type_bit_fields());
+       const ValueType target_type =
+diff --git a/src/wasm/interpreter/wasm-interpreter.h b/src/wasm/interpreter/wasm-interpreter.h
+index 525fe2a4c47..238bd45c7de 100644
+--- a/src/wasm/interpreter/wasm-interpreter.h
++++ b/src/wasm/interpreter/wasm-interpreter.h
+@@ -1280,8 +1280,9 @@ struct BranchOnCastData {
+                    uint32_t target_type_bit_fields)
+       : label_depth_(label_depth),
+         flags_(SrcIsNullField::encode(src_is_null) |
+-               ResIsNullField::encode(src_is_null) |
+-               TargetTypeField::encode(src_is_null)) {}
++               ResIsNullField::encode(res_is_null) |
++               TargetTypeField::encode(target_type_bit_fields)) {}
++  BranchOnCastData() : label_depth_(0), flags_(0) {}
+ 
+   uint32_t label_depth() const { return label_depth_; }
+   bool src_is_null() const { return SrcIsNullField::decode(flags_); }
+@@ -1302,6 +1303,8 @@ struct BranchOnCastData {
+ 
+ struct WasmInstruction {
+   union Optional {
++    Optional() : index(0) {}
++
+     uint32_t index;  // global/local/label/memory/table index
+     int32_t i32;
+     int64_t i64;
+diff --git a/test/mjsunit/mjsunit.status b/test/mjsunit/mjsunit.status
+index 9ebb81d5493..ffe4133e247 100644
+--- a/test/mjsunit/mjsunit.status
++++ b/test/mjsunit/mjsunit.status
+@@ -681,6 +681,7 @@
+ 
+   # --experimental-wasm-wasmfx
+   'regress/wasm/regress-455832038': [SKIP],
++  'wasm/resume-throw': [SKIP],
+   'wasm/stack-switching*': [SKIP],
+ 
+   # --experimental-wasm-growable-stacks
+@@ -699,6 +700,7 @@
+   'wasm/gc-casts-from-any': [SKIP],
+   'wasm/reference-globals-import': [SKIP],
+   'wasm/reference-table-js-interop': [SKIP],
++  'wasm/regress-467863659': [SKIP],
+   'wasm/stringref*': [SKIP],
+   'wasm/stringview-valuestack': [SKIP],
+   'wasm/turboshaft/instruction-selection': [SKIP],
